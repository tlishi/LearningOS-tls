### 这周在看《程序员的自我修养》，主要是讲程序链接、装载的一些底层知识，认知上收获不少。现已经看到第三章：目标文件里有什么。**正好写点笔记回顾下。顺便熟悉md语法：**

目标文件结构上已经非常接近可执行文件了，只是它还没链接，有些符号或地址还没调整，但它确实是按照可执行文件格式存储的。

1. 目标文件格式
   * 可执行文件分Windows下的PE（.obj文件）和Linux的ELF（**.o文件**），它们都是COFF格式的变种。还有动态链接库（DLL，Windows下.dll文件，**Linux下.so**）和静态链接库（Windows的.lib，**Linux的.a**）。也有一些其他类型不太常见的可执行文件，如Unix的a.out。
   * 静态链接库：实质是把很多目标文件绑在一起，加些索引，形成一个包含很多目标文件的包。
2. 目标文件里的样子
   * 目标文件一般含有机器指令代码、数据以及其他链接阶段需要的信息。
   * 它们是按照**段**（segment）或者**节**（section）形式存储，段表示一个特定长度区域。
   * 常见有文件头、.tetx、.data、.bss段，分别放描述文件信息（包括**段表**）、指令、数据和给未定义变量预留的空间。
   * 指令和数据分段存储好处很多：1. 可划分读写权限；2. 提升现代CPU强大缓存系统的命中率；（*没深究，但看上去像是那么回事*）3.多个进程中，实现共享指令、共享只读数据区。**节省大量内存**
3. 分析*.o文件
   * 代码段：这个区域是许多二进制的机器指令排列。（*如果反汇编机器指令，还能看到这个段包含的就是咱们写的代码和函数的指令排列，真特喵神奇和真实！*）
   * 数据段：**保存那些已经初始化了的全局和局部静态变量**；还有个.rodata段，一般存放一些只读变量（如const修饰）和字符串常量
   * .bss段：**存放未初始化的全局变量和局部静态变量**，准确来说是.bss为它们预留了内存空间。**有趣的现象：**有些静态变量初始化为0，也会被编译器优化地放入.bss段，因为值为0可以被认为是未初始化的。
   * 其他段表：.strtab存放ELF文件用到的字符串、.shstrtab段名表
4. ELF（linux）文件
   + 文件头：包含整个文件基本信息，程序入口地址等
   + 段表：是一个数组，数组元素是一种描述**段特征**的结构体，段特征包含了段名，段类型，大小和偏移等信息。**决定段功能的是段类型，不是段名**
   + 重定位表：因为目标文件需要链接，所以.rel.text段（重定位表）针对.text段中，对绝对地址的引用来链接。（如printf函数调用）
   + 字符串表：将ELF文件中用到的字符串，集中存放，通过偏移来引用字符串（*看到了其中字符串以‘\0’结尾的用处*）；分.strtab和.shstrtab段，存放的字符串稍有不同

